<!DOCTYPE html>
<html>
<head>
    <title>Addis Bingo Admin</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #f4f7f6; }
        #login-container { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; }
        #admin-content { display: none; padding: 20px; }
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 20px; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .btn-send { background: #0088cc; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>

<div id="login-container">
    <h1>ðŸ”’ Restricted Access</h1>
    <script async src="https://telegram.org/js/telegram-widget.js?22" 
            data-telegram-login="YOUR_BOT_USERNAME" 
            data-size="large" 
            data-onauth="onTelegramAuth(user)" 
            data-request-access="write"></script>
</div>

<div id="admin-content">
    <div class="stats-grid">
        <div class="card"><h3>Total Users</h3><p id="stat-users">0</p></div>
        <div class="card"><h3>Total Revenue</h3><p id="stat-rev">0 ETB</p></div>
        <div class="card"><h3>Pending</h3><p id="stat-pending">0</p></div>
    </div>

    <div class="card">
        <h3>ðŸ“¢ Send Global Announcement</h3>
        <textarea id="bc-text" style="width:100%; height:80px;" placeholder="Enter message..."></textarea>
        <button class="btn-send" onclick="broadcast()">ðŸš€ Broadcast to All</button>
    </div>
</div>

<script>
    const ADMIN_ID = YOUR_NUMERIC_ID; 
    const SB_URL = 'YOUR_SUPABASE_URL';
    const SB_KEY = 'YOUR_SUPABASE_ANON_KEY';
    const _supabase = supabase.createClient(SB_URL, SB_KEY);

    function onTelegramAuth(user) {
        if (user.id === ADMIN_ID) {
            localStorage.setItem('verified_admin', user.id);
            location.reload();
        } else {
            alert("Access Denied.");
        }
    }

    async function broadcast() {
        const message = document.getElementById('bc-text').value;
        const res = await fetch('/api/broadcast', {
            method: 'POST',
            body: JSON.stringify({ admin_id: ADMIN_ID, message: message })
        });
        const data = await res.json();
        alert(`Sent to ${data.sent_to} users!`);
    }

    window.onload = () => {
        if (localStorage.getItem('verified_admin') == ADMIN_ID) {
            document.getElementById('login-container').style.display = 'none';
            document.getElementById('admin-content').style.display = 'block';
            loadData();
        }
    };

    async function loadData() {
        const { data: users } = await _supabase.from('users').select('*');
        const { data: reqs } = await _supabase.from('requests').select('*');
        document.getElementById('stat-users').innerText = users.length;
        document.getElementById('stat-rev').innerText = reqs.filter(r => r.status === 'approved').reduce((a, b) => a + b.amount, 0);
        document.getElementById('stat-pending').innerText = reqs.filter(r => r.status === 'pending').length;
    }
</script>
</body>
</html>